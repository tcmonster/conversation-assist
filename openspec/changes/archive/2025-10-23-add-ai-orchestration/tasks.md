## 1. Prompt 组合层
- [x] 1.1 定义 prompt schema 与任务类型(TypeScript 类型 + 常量),覆盖系统、参考、引用、语气、回复语言、用户意图、历史消息字段  
- [x] 1.2 新建 prompt 组合器模块,读取设置与会话上下文,提供 `buildPromptPayload(task, options)` API 并包含最少单元测试  
- [x] 1.3 为 prompts/ 目录建立示例模板与索引结构,确保后续可扩展标签/语气预设

## 2. AI Client 封装
- [x] 2.1 引入统一 `invokeAiTask` 客户端,抽象翻译/解析与回复生成,实现请求参数映射与错误分类  
- [x] 2.2 提供本地 mock/延迟模拟,在无真实 API Key 时返回固定示例结果并写入日志,便于离线演示  
- [ ] 2.3 编写客户端最小单元测试,覆盖成功/错误路径

## 3. 翻译与解析流程
- [x] 3.1 在 partner 消息录入后触发翻译/解析任务,将结果写入对应 mirror(analysis) 字段  
- [x] 3.2 允许用户重新触发翻译,处理加载态/错误态提示,并保留最后一次成功内容  
- [x] 3.3 会话状态持久化翻译结果与时间戳,刷新后可还原

## 4. 回复生成流程
- [x] 4.1 记录会话级回复语言、语气预设、选中参考/引用项,默认使用对方语言并允许修改  
- [x] 4.2 触发生成回复时调用 prompt 组合器与 AI Client,将结果写入 intent/草稿并更新消息流  
- [x] 4.3 处理重试/取消场景,确保 UI 反馈与状态一致

## 5. 控制面板联动
- [x] 5.1 控制面板渲染真实参考信息/引用信息,支持多选并同步到会话状态  
- [x] 5.2 新增 Prompt 预览 Modal,展示最终 JSON,包含复制动作与错误提示  
- [x] 5.3 将语气 Tabs 与回复语言选择与会话状态/生成流程打通

## 6. 验证
- [x] 6.1 自测主流程: 录入消息 → 自动翻译 → 选择上下文 → 生成回复 → 预览 Prompt  
- [ ] 6.2 运行相关单元测试/集成测试并更新文档示例(如适用)  
- [x] 6.3 执行 `openspec validate add-ai-orchestration --strict`
